# .github/workflows/publish-images.yml
name: Build and Push Images

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write # Required to push to GHCR

jobs:
  ### --------------------------------------------------------------------
  ###  JOB 1: Detect Changes
  ###  This job checks which image directories have changed.
  ### --------------------------------------------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # We output a single JSON array named 'services'
      # e.g., ["dns-resolver", "vip-manager"]
      services: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use paths-filter action
        id: filter
        uses: petermetz/paths-filter@5ee2f5d4cf5d7bdd998a314a42da307e2ae1639d
        with:
          predicate-quantifier: 'every'
          # Define a filter for each image.
          # The 'outputs.changes' will contain an array of the keys
          # for the filters that matched.
          filters: |
            dns-resolver:
                - 'dns-resolver/**'
                - '!**/*.md'
            vip-manager:
                - 'vip-manager/**'
                - '!**/*.md'
            blocklist-updater:
                - 'blocklist-updater/**'
                - '!**/*.md'
            stats-collector:
                - 'stats-collector/**'
                - '!**/*.md'
            installer:
                - 'installer/**'
                - '!**/*.md'
    

  ### --------------------------------------------------------------------
  ###  JOB 2: Run Tests
  ###  Runs tests for each changed service that has test files.
  ### --------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.services != '[]'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov

      - name: Check for test files
        id: check_tests
        run: |
          if ls ${{ matrix.service }}/test_*.py 1> /dev/null 2>&1; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "✅ Found test files in ${{ matrix.service }}"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "ℹ️  No test files found in ${{ matrix.service }}"
          fi

      - name: Install service-specific dependencies
        if: steps.check_tests.outputs.has_tests == 'true'
        run: |
          if [ -f ${{ matrix.service }}/requirements.txt ]; then
            pip install -r ${{ matrix.service }}/requirements.txt
          fi
          if [ -f ${{ matrix.service }}/test-requirements.txt ]; then
            pip install -r ${{ matrix.service }}/test-requirements.txt
          fi

      - name: Run pytest
        if: steps.check_tests.outputs.has_tests == 'true'
        run: |
          cd ${{ matrix.service }}
          pytest -v --cov=. --cov-report=term-missing

  ### --------------------------------------------------------------------
  ###  JOB 3: Build and Push
  ###  Runs a matrix build, one for each service in the output array.
  ###  Only runs if tests pass.
  ### --------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    # Only run this job if the 'services' array is not empty
    if: needs.detect-changes.outputs.services != '[]'
    strategy:
      fail-fast: false
      # Create a matrix from the JSON array output by the 'detect-changes' job
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # *** Set up QEMU for multi-arch emulation ***
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # *** Set up Docker Buildx (the multi-arch builder) ***
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Parameterized to use the matrix variable
      - name: Read version from VERSION file
        id: read_version
        run: |
          echo "version=$(cat ${{ matrix.service }}/VERSION)" >> $GITHUB_OUTPUT

      - name: Create v-prefixed version for tags
        id: version_tag
        run: |
          echo "vtag=v$(cat ${{ matrix.service }}/VERSION)" >> $GITHUB_OUTPUT

      - name: Read description from Containerfile
        id: extract_description
        run: |
          DESC=$(awk -F'"' '/org.opencontainers.image.description/ {print $2}' ./${{ matrix.service }}/Containerfile)
          echo "description=$DESC" >> $GITHUB_OUTPUT

      # Parameterized to use the matrix variable
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ matrix.service }}
          tags: |
            # Tag with the v-prefixed version from the VERSION file
            type=raw,value=${{ steps.version_tag.outputs.vtag }}
            # If this is a push to 'main', also tag as 'latest'
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      # Parameterized to use the matrix variable
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Containerfile
          # Only push if it's NOT a pull request
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_VERSION=${{ steps.read_version.outputs.version }}
          
          # *** Define all platforms to build ***
          platforms: linux/amd64,linux/arm64

          # *** Add caching to speed up builds ***
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=image,name=target,annotation-index.org.opencontainers.image.description=${{ steps.extract_description.outputs.description }}
