# .github/workflows/autobump-versions.yml
name: ‚¨ÜÔ∏è Autobump Image Versions

on:
  pull_request:
    types: [opened, synchronize, reopened]

# This action needs to write back to the PR branch
permissions:
  contents: write
  pull-requests: read

jobs:
  autobump:
    name: ü§ñ Bump Version
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout PR Branch
        uses: actions/checkout@v4
        with:
          # Check out the PR branch (github.head_ref)
          ref: ${{ github.head_ref }}
          # Fetch full history to be able to diff against the base branch
          fetch-depth: 0

      - name: ‚öôÔ∏è Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: üì¶ Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install semver

      - name: ‚ö° Run Version Bump Script
        id: bump_script
        run: |
          python .github/scripts/bump_versions.py
        env:
          # Set env vars for the script
          BASE_REF: "origin/${{ github.base_ref }}"
          HEAD_REF: "origin/${{ github.head_ref }}"

      - name: ‚¨ÜÔ∏è Commit and Push Changes
        if: steps.bump_script.outputs.commit_made == 'true'
        run: |
          echo "Committing and pushing version bumps..."
          # Add all VERSION files that were modified
          git add ./**/VERSION
          git commit -m "chore: automatic version bumps [skip ci]"
          # Push to the PR branch (HEAD)
          git push origin HEAD:${{ github.head_ref }}
