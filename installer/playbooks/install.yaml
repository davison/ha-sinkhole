---
- name: Install ha-sinkhole DNS nodes
  hosts: dns_nodes
  become: true
  strategy: linear
  roles:
    - ha_sinkhole_common

  handlers:
    - name: Restart vip-manager
      ansible.builtin.systemd:
        name: vip-manager.service
        state: restarted
        scope: system

    - name: Restart dns-resolver
      become: false
      ansible.builtin.systemd:
        name: dns-resolver.service
        state: restarted
        scope: user

    - name: Restart stats-collector
      become: false
      ansible.builtin.systemd:
        name: stats-collector.service
        state: restarted
        scope: user

    - name: Restart blocklist-updater timer
      become: false
      ansible.builtin.systemd:
        name: blocklist-updater.timer
        state: restarted
        scope: user

  tasks:
    - name: âš™ï¸  Setup environment and dependencies
      tags: [setup]
      block:
        - name: Ensure podman is installed
          ansible.builtin.package:
            name: podman
            state: present

        - name: Enable user lingering for {{ ansible_user }}
          ansible.builtin.command: "loginctl enable-linger {{ ansible_user }}"
          args:
            creates: "/var/lib/systemd/linger/{{ ansible_user }}"

        - name: Create data dir
          ansible.builtin.file:
            path: "{{ ha_sinkhole_common_dir }}/data"
            state: directory
            owner: "{{ ansible_user }}"
            mode: "0755"

        - name: Create local hosts aliases
          ansible.builtin.template:
            src: "local.hosts.j2"
            dest: "{{ ha_sinkhole_common_dir }}/data/local.hosts"
            owner: "{{ ansible_user }}"
            mode: "0644"

        - name: Create or force update of podman secret for Prometheus API token
          when: cloud_api_token is defined
          become: false
          containers.podman.podman_secret:
            name: prometheus_api_token
            state: present
            data: "{{ cloud_api_token }}"
            # The 'force: true' ensures the secret is overwritten even
            # if it already exists, as the contents cannot be compared.
            force: true

        - name: Ensure secret is removed if token variable is NOT defined
          when: cloud_api_token is not defined
          containers.podman.podman_secret:
            name: prometheus_api_token
            state: absent

    - name: ðŸŽ¯  Merge host-specific HA variables
      ansible.builtin.set_fact:
        # This merges the base host_vars (if any are defined) with the overrides.
        # The | default({}) prevents errors if one or other are undefined.
        host_vars: "{{ host_vars | default({}) | combine(host_vars_overrides | default({})) }}"

    - name: ðŸ“¦  Install systemd units
      tags: [systemd]
      block:
        - name: Fetch Deployment Manifest Artifact
          tags: [manifest]
          ansible.builtin.uri:
            # URL is constructed using the repo owner, repo name, release tag, and file name.
            url: "{{ ha_sinkhole_common_gitrepo }}{{ ha_sinkhole_common_manifest_file }}"
            method: GET
            # Ensure the content is returned in the result object, not just HTTP status.
            return_content: true
            # Setting validate_certs to false might be required if Ansible runner environment has issues,
            # but generally safe to omit as GitHub uses standard certs.
            # validate_certs: false
          register: manifest_lookup

        - name: Parse YAML and set version facts
          tags: [manifest]
          ansible.builtin.set_fact:
            # Convert the content string into a usable Ansible dictionary
            ha_sinkhole_manifest: "{{ manifest_lookup.content | from_yaml }}"

        - name: Create systemd directories
          tags: [systemd]
          ansible.builtin.file:
            path: "{{ ha_sinkhole_common_systemd_dir }}/users"
            state: directory
            mode: "0755"

        - name: DEBUG Verify manifest file content was fetched
          tags: [manifest]
          ansible.builtin.debug:
            msg: "Fetched channels: {{ ha_sinkhole_manifest | to_json }}"
          when: ansible_verbosity > 0 # Only when running with -v

        - name: Copy pod file
          tags: [dns-resolver, stats-collector]
          ansible.builtin.copy:
            src: "ha-node.pod"
            dest: "{{ ha_sinkhole_common_systemd_dir }}/users/ha-node.pod"
            mode: "0644"
          notify:
            - Reload systemd (user)
            - Restart dns-resolver
            - Restart stats-collector

        - name: Template vip-manager container file
          tags: [vip-manager]
          ansible.builtin.template:
            src: "vip-manager.container.j2"
            dest: "{{ ha_sinkhole_common_systemd_dir }}/vip-manager.container"
            mode: "0644"
          notify:
            - Reload systemd (root)
            - Restart vip-manager

        - name: Template dns-resolver container file
          tags: [dns-resolver]
          ansible.builtin.template:
            src: "dns-resolver.container.j2"
            dest: "{{ ha_sinkhole_common_systemd_dir }}/users/dns-resolver.container"
            mode: "0644"
          notify:
            - Reload systemd (user)
            - Restart dns-resolver

        - name: Template stats-collector container file
          tags: [stats-collector]
          ansible.builtin.template:
            src: "stats-collector.container.j2"
            dest: "{{ ha_sinkhole_common_systemd_dir }}/users/stats-collector.container"
            mode: "0644"
          notify:
            - Reload systemd (user)
            - Restart stats-collector

        - name: Copy user systemd timer file
          tags: [blocklist]
          ansible.builtin.copy:
            src: "blocklist-updater.timer"
            dest: "/etc/systemd/user/blocklist-updater.timer"
            mode: "0644"
          notify:
            - Reload systemd (user)
            - Restart blocklist-updater timer

        - name: Template blocklist-updater container file
          tags: [blocklist]
          ansible.builtin.template:
            src: "blocklist-updater.container.j2"
            dest: "{{ ha_sinkhole_common_systemd_dir }}/users/blocklist-updater.container"
            mode: "0644"
          notify: Reload systemd (user)

        - name: Flush handlers to reload systemd
          ansible.builtin.meta: flush_handlers

    - name: ðŸš€ Enable and start services
      loop:
        - { name: "vip-manager.service", state: started, scope: system }
        - { name: "dns-resolver.service", state: started, scope: user }
        - { name: "stats-collector.service", state: started, scope: user }
        - { name: "blocklist-updater.timer", state: started, scope: user }
      loop_control:
        loop_var: current_service
      # For EACH item, we call the specific task file
      ansible.builtin.include_tasks:
        file: roles/ha_sinkhole_common/tasks/manage_service.yml
      # Pass variables down into that file, mapped from the loop item
      vars:
        service_name: "{{ current_service.name }}"
        service_state: "{{ current_service.state }}"
        service_scope: "{{ current_service.scope }}"
